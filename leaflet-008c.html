<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Peta Hierarki: Provinsi → Kabupaten → Kecamatan → Kelurahan</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
        <style>
            html, body, #map {
                height: 100%;
                margin: 0;
                padding: 0;
            }
            .info {
                padding: 6px 8px;
                font: 14px/16px Arial, Helvetica, sans-serif;
                background: rgba(255, 255, 255, 0.9);
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
                border-radius: 4px;
                white-space: pre-line;
            }
            .leaflet-control-reset {
                background: white;
                padding: 6px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script type="text/javascript" src="diy_provinsi.js"></script>
        <script type="text/javascript" src="diy_kabupaten_kota.js"></script>
        <script type="text/javascript" src="diy_kecamatan.js"></script>
        <script type="text/javascript" src="diy_kelurahan_desa.js"></script>
        <script>
            // -------------
            // UTILITY KECIL
            // -------------
            function getProp(featureProps, keys) {
                if (!featureProps)
                    return undefined;
                
                for (const k of keys) {
                    for (const propKey of Object.keys(featureProps)) {
                        if (propKey.toLowerCase() === k.toLowerCase())
                            return featureProps[propKey];
                    }
                }
                
                return undefined;
            }
            
            function normalize(s) {
                return (s === undefined || s === null) ? '' : String(s).trim().toLowerCase();
            }
            
            // -----------------
            // INISIALISASI PETA
            // -----------------
            const map = L.map(
                'map',
                { preferCanvas: true }
            ).setView([-6.88, 107.54], 10);
            
            L.tileLayer(
                'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                {
                    maxZoom: 17,
                    attribution: '&copy; OpenStreetMap'
                }
            ).addTo(map);
            
            map.attributionControl.setPrefix(false);
            
            // ----------------
            // INFO CONTROL BOX
            // ----------------
            const info = L.control({ position: 'topright' });
            
            info.onAdd = function () {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                
                return this._div;
            };
            
            // ✅ PERUBAHAN UTAMA DI SINI
            info.update = function (props) {
                if (!props) {
                    this._div.innerHTML = `<b>Peta Hierarki</b>\nKlik polygon untuk turun level.`;
                    
                    return;
                }
                
                let lines = [];
                
                if (props.provinsi)
                    lines.push(`Provinsi:  <b>${props.provinsi}</b>`);
                
                if (props.kabupaten)
                    lines.push(`Kabupaten/Kota:  <b>${props.kabupaten}</b>`);
                
                if (props.kecamatan)
                    lines.push(`Kecamatan:  <b>${props.kecamatan}</b>`);
                
                if (props.kelurahan)
                    lines.push(`Kelurahan/Desa:  <b>${props.kelurahan}</b>`);

                this._div.innerHTML = lines.join('\n');
            };
            // ✅ SELESAI PERUBAHAN
            
            info.addTo(map);
            
            // ------------
            // LAYER GLOBAL
            // ------------
            let provinsiLayer = null;
            let kabupatenLayer = null;
            let kecamatanLayer = null;
            let kelurahanLayer = null;
            let selectedKabupaten = null;
            let selectedKecamatan = null;
            
            // STYLES
            const styleProvinsi = {
                color: '#0b6e4f',
                weight: 3,
                fillOpacity: 0.03
            };
            
            const styleKabupaten = {
                color: '#1f78b4',
                weight: 2,
                fillOpacity: 0.12
            };
            const styleKabupatenHover = {
                color: '#08519c',
                weight: 3,
                fillOpacity: 0.18
            };
            
            const styleKecamatan = {
                color: '#2b8cbe',
                weight: 1,
                fillOpacity: 0.10
            };
            const styleKecamatanHover = {
                color: '#d94801',
                weight: 2,
                fillOpacity: 0.18
            };
            
            const styleKelurahan = {
                color: '#31a354',
                weight: 1,
                fillOpacity: 0.12
            };
            const styleKelurahanHover = {
                color: '#ff6600',
                weight: 2,
                fillOpacity: 0.2
            };
            
            // ✅ PERUBAHAN UTAMA DI SINI
            function bindTooltip(layer, props) {
                const prov = getProp(
                    props,
                    ['provinsi', 'name']
                );
                const kab = getProp(
                    props,
                    ['kabupaten_kota', 'kabupaten', 'kota', 'nama']
                );
                const kec = getProp(
                    props,
                    ['kecamatan', 'nama']
                );
                const kel = getProp(
                    props, ['kelurahan_desa', 'nama']
                );
                
                let html = '';
                
                if (prov)
                    html += `Provinsi: <b>${prov}</b>`;
                
                if (kab)
                    html += (html ? '<br>' : '') + `Kabupaten/Kota: <b>${kab}</b>`;
                
                if (kec)
                    html += (html ? '<br>' : '') + `Kecamatan: <b>${kec}</b>`;
                
                if (kel)
                    html += (html ? '<br>' : '') + `Kelurahan/Desa: <b>${kel}</b>`;

                if (html)
                    layer.bindTooltip(
                        html,
                        {
                            sticky: true,
                            direction: 'top'
                        }
                    );
            }
            // ✅ SELESAI PERUBAHAN
            
            // ------------------------------
            // KAB/KOTA LAYER (TAMPIL SEMUA)
            // ------------------------------
            if (typeof diy_kabupaten_kota === 'undefined') {
                alert('File diy_kabupaten_kota.js tidak ditemukan.');
            }
            else {
                kabupatenLayer = L.geoJSON(
                    diy_kabupaten_kota,
                    {
                        style: styleKabupaten,
                        onEachFeature: function (feature, layer) {
                            bindTooltip(layer, feature.properties);
                            
                            layer.on({
                                mouseover() {
                                    layer.setStyle(styleKabupatenHover);
                                    
                                    info.update(
                                        {
                                            provinsi: getProp(
                                                feature.properties,
                                                ['provinsi', 'name']
                                            ) || '-',
                                            kabupaten: getProp(
                                                feature.properties,
                                                ['kabupaten_kota', 'kabupaten', 'nama']
                                            )
                                        }
                                    );
                                },
                                mouseout() {
                                    if (selectedKabupaten !== layer)
                                        kabupatenLayer.resetStyle(layer);
                                    
                                    info.update();
                                },
                                click() {
                                    if (selectedKabupaten && selectedKabupaten !== layer)
                                        kabupatenLayer.resetStyle(selectedKabupaten);
                                    
                                    selectedKabupaten = layer;
                                    
                                    layer.setStyle(
                                        {
                                            color: '#b22222',
                                            weight: 3,
                                            fillOpacity: 0.18
                                        }
                                    );
                                    
                                    const title = getProp(
                                        feature.properties,
                                        ['kabupaten_kota', 'kabupaten', 'nama']
                                    );
                                    
                                    map.fitBounds(layer.getBounds(), { maxZoom: 13 });
                                    
                                    showKecamatanFor(title);
                                }
                            });
                        }
                    }
                ).addTo(map);
            }
            
            // ---------------------------------
            // KELURAHAN LAYER (KOSONG AWALNYA)
            // ---------------------------------
            kelurahanLayer = L.geoJSON(null, {
                style: styleKelurahan,
                onEachFeature(feature, layer) {
                    bindTooltip(layer, feature.properties);
                    
                    layer.on(
                        {
                            mouseover() {
                                layer.setStyle(styleKelurahanHover);
                                
                                info.update({
                                    provinsi: getProp(
                                        feature.properties,
                                        ['provinsi', 'name']
                                    ) || '-',
                                    kabupaten: getProp(
                                        feature.properties,
                                        ['kabupaten_kota', 'kabupaten', 'kota', 'nama']
                                    ),
                                    kecamatan: getProp(
                                        feature.properties,
                                        ['kecamatan', 'nama']
                                    ),
                                    kelurahan: getProp(
                                        feature.properties,
                                        ['kelurahan_desa', 'nama']
                                    )
                                });
                            },
                            mouseout() {
                                kelurahanLayer.resetStyle(layer);
                                
                                info.update();
                            },
                            click() {
                                map.fitBounds(
                                    layer.getBounds(),
                                    { maxZoom: 17 }
                                );
                            }
                        }
                    );
                }
            }).addTo(map);
            
            // --------------------------
            // FUNGSI: TAMPILKAN KECAMATAN
            // --------------------------
            function showKecamatanFor(namaKabupaten) {
                kelurahanLayer.clearLayers();
                
                if (!namaKabupaten)
                    return;
                
                const nk = normalize(namaKabupaten);
                const feats = (Array.isArray(diy_kecamatan && diy_kecamatan.features) ? diy_kecamatan.features : []).filter(
                    f => normalize(
                        getProp(
                            f.properties,
                            ['kabupaten_kota', 'kabupaten', 'kabkota', 'kota']
                        )
                    ) === nk
                );
                
                if (feats.length === 0) {
                    if (kecamatanLayer && map.hasLayer(kecamatanLayer))
                        map.removeLayer(kecamatanLayer);
                    
                    return;
                }
                
                const newKecLayer = L.geoJSON(
                    feats,
                    {
                        style: styleKecamatan,
                        onEachFeature(feature, layer) {
                            bindTooltip(layer, feature.properties);
                            
                            layer.on(
                                {
                                    mouseover() {
                                        layer.setStyle(styleKecamatanHover);
                                        
                                        info.update({
                                            provinsi: getProp(
                                                feature.properties,
                                                ['provinsi', 'name']
                                            ) || '-',
                                            kabupaten: namaKabupaten,
                                            kecamatan: getProp(
                                                feature.properties,
                                                ['kecamatan', 'nama']
                                            )
                                        });
                                    },
                                    mouseout() {
                                        if (selectedKecamatan !== layer && kecamatanLayer)
                                            kecamatanLayer.resetStyle(layer);
                                        
                                        info.update();
                                    },
                                    click() {
                                        if (selectedKecamatan && selectedKecamatan !== layer && kecamatanLayer)
                                            kecamatanLayer.resetStyle(selectedKecamatan);
                                        
                                        selectedKecamatan = layer;
                                        
                                        layer.setStyle({ color: '#800000', weight: 3, fillOpacity: 0.2 });
                                        
                                        const title = getProp(feature.properties, ['kecamatan', 'nama']);
                                        
                                        map.fitBounds(layer.getBounds(), { maxZoom: 15 });
                                        
                                        showKelurahanFor(title);
                                    }
                                }
                            );
                        }
                    }
                );
                
                if (kecamatanLayer && map.hasLayer(kecamatanLayer))
                    map.removeLayer(kecamatanLayer);
                
                kecamatanLayer = newKecLayer.addTo(map);
                kecamatanLayer.eachLayer(l => l.bringToFront());
            }

            // ----------------------------
            // FUNGSI: TAMPILKAN KELURAHAN
            // ----------------------------
            function showKelurahanFor(namaKecamatan) {
                kelurahanLayer.clearLayers();
                
                if (!namaKecamatan)
                    return;
                
                const nk = normalize(namaKecamatan);
                const feats = (Array.isArray(diy_kelurahan_desa && diy_kelurahan_desa.features) ? diy_kelurahan_desa.features : []).filter(
                    f => normalize(
                        getProp(
                            f.properties,
                            ['kecamatan', 'Kecamatan', 'kec']
                        )
                    ) === nk
                );
                
                if (feats.length === 0)
                    return;
                
                kelurahanLayer.addData(feats);
                kelurahanLayer.eachLayer(l => l.bringToFront());
            }
            
            // ----------------------
            // BANGUN / TAMPILKAN PROVINSI
            // ----------------------
            (
                function initProvinsiView() {
                    try {
                        if (typeof diy_provinsi !== 'undefined' && diy_provinsi && diy_provinsi.features && diy_provinsi.features.length > 0) {
                            provinsiLayer = L.geoJSON(
                                diy_provinsi,
                                {
                                    style: styleProvinsi,
                                    onEachFeature(feature, layer) {
                                        bindTooltip(layer, feature.properties);
                                    }
                                }
                            ).addTo(map);
                            
                            const b = provinsiLayer.getBounds();
                            
                            if (b && b.isValid())
                                map.fitBounds(b);
                        }
                        else {
                            const feats = Array.isArray(diy_kabupaten_kota && diy_kabupaten_kota.features) ? diy_kabupaten_kota.features : [];
                            
                            if (feats.length === 0)
                                return;
                            
                            let unionPoly = feats[0];
                            let unionSucceeded = true;
                            
                            for (let i = 1; i < feats.length; i++) {
                                try {
                                    unionPoly = turf.union(unionPoly, feats[i]);
                                }
                                catch {
                                    unionSucceeded = false; break;
                                }
                            }
                            
                            if (!unionSucceeded) {
                                const fullFc = turf.featureCollection(feats);
                                const bbox = turf.bbox(fullFc);
                                unionPoly = turf.bboxPolygon(bbox);
                            }
                            
                            provinsiLayer = L.geoJSON(unionPoly, { style: styleProvinsi }).addTo(map);
                            const b = provinsiLayer.getBounds();
                            
                            if (b && b.isValid())
                                map.fitBounds(b);
                        }
                        
                        if (kabupatenLayer)
                            kabupatenLayer.eachLayer(l => l.bringToFront());
                    }
                    catch (err) {
                        console.error('initProvinsiView error:', err);
                    }
                }
            )();

            // --------------------------
            // RESET TO PROVINCE VIEW
            // --------------------------
            function resetToProvince() {
                kelurahanLayer.clearLayers();
                
                if (kecamatanLayer && map.hasLayer(kecamatanLayer))
                    map.removeLayer(kecamatanLayer);
                
                if (kabupatenLayer)
                    kabupatenLayer.eachLayer(l => kabupatenLayer.resetStyle(l));
                
                selectedKabupaten = null;
                selectedKecamatan = null;
                
                if (provinsiLayer && provinsiLayer.getBounds && provinsiLayer.getBounds().isValid())
                    map.fitBounds(provinsiLayer.getBounds());
                else if (kabupatenLayer && kabupatenLayer.getBounds && kabupatenLayer.getBounds().isValid())
                    map.fitBounds(kabupatenLayer.getBounds());
                
                info.update();
            }

            const ResetControl = L.Control.extend({
                options: { position: 'topleft' },
                onAdd: function () {
                    const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-reset');
                    
                    c.innerHTML = 'Reset to Province';
                    c.style.padding = '6px';
                    c.style.background = 'white';
                    c.style.cursor = 'pointer';
                    
                    L.DomEvent.on(
                        c,
                        'click',
                        function (e) {
                            e.stopPropagation(); resetToProvince();
                        }
                    );
                    
                    return c;
                }
            });
            map.addControl(new ResetControl());
        </script>
    </body>
</html>
