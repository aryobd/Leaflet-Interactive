<!DOCTYPE html>
<html lang="id">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>Peta Hierarki: Provinsi → Kabupaten → Kecamatan → Kelurahan</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <!-- Turf untuk union / bbox fallback -->
        <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
        <style>
            html,body,#map { height:100%; margin:0; padding:0; }
            .info {
            padding:6px 8px;
            font:14px/16px Arial, Helvetica, sans-serif;
            background: rgba(255,255,255,0.9);
            box-shadow:0 0 10px rgba(0,0,0,0.2);
            border-radius:4px;
            }
            .leaflet-control-reset {
            background: white;
            padding: 6px;
            cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <!-- Pastikan file GeoJSON berada di folder yang sama -->
        <!-- Jika Anda sudah punya file provinsi, biarkan; jika tidak, provinsi akan dibangun dari kabupaten -->
        <script type="text/javascript" src="diy_provinsi.js"></script>
        <script type="text/javascript" src="diy_kabupaten_kota.js"></script>
        <script type="text/javascript" src="diy_kecamatan.js"></script>
        <script type="text/javascript" src="diy_kelurahan_desa.js"></script>
        <script>
            // ----------------------
            // Utility kecil
            // ----------------------
            function getProp(featureProps, keys) {
                // cari key yang tersedia (case-insensitive)
                if (!featureProps)
                    return undefined;
                for (const k of keys) {
                    for (const propKey of Object.keys(featureProps)) {
                        if (propKey.toLowerCase() === k.toLowerCase()) return featureProps[propKey];
                    }
                }
                
                return undefined;
            }
            
            function normalize(s) {
                return (s === undefined || s === null) ? '' : String(s).trim().toLowerCase();
            }
            
            // ----------------------
            // Inisialisasi Peta
            // ----------------------
            const map = L.map('map', { preferCanvas: true }).setView([-6.88, 107.54], 10);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
            map.attributionControl.setPrefix(false);
            
            // Kontrol info kecil
            const info = L.control({ position: 'topright' });
            
            info.onAdd = function () {
                this._div = L.DomUtil.create('div', 'info');
                this.update();
                
                return this._div;
            };
            info.update = function (props) {
              if (!props) this._div.innerHTML = '<b>Provinsi → Kabupaten → Kecamatan → Kelurahan</b><br>Klik polygon untuk turun level.';
              else this._div.innerHTML = `<b>${props.title}</b><br>${props.subtitle || ''}`;
            };
            info.addTo(map);
            
            // ----------------------
            // Layer global
            // ----------------------
            let provinsiLayer = null;       // polygon provinsi (jika ada atau hasil union)
            let kabupatenLayer = null;      // semua kabupaten (ditampilkan di awal)
            let kecamatanLayer = null;      // layer kecamatan saat kabupaten diklik (dibuat on-demand)
            let kelurahanLayer = null;      // layer kelurahan saat kecamatan diklik
            
            let selectedKabupaten = null;
            let selectedKecamatan = null;
            
            // Styles
            const styleProvinsi = { color: '#0b6e4f', weight: 3, fillOpacity: 0.03 };
            const styleKabupaten = { color: '#1f78b4', weight: 2, fillOpacity: 0.12 };
            const styleKabupatenHover = { color: '#08519c', weight: 3, fillOpacity: 0.18 };
            const styleKecamatan = { color: '#2b8cbe', weight: 1, fillOpacity: 0.10 };
            const styleKecamatanHover = { color: '#d94801', weight: 2, fillOpacity: 0.18 };
            const styleKelurahan = { color: '#31a354', weight: 1, fillOpacity: 0.12 };
            const styleKelurahanHover = { color: '#ff6600', weight: 2, fillOpacity: 0.2 };
            
            function bindTooltip(layer, props) {
              const name = getProp(props, ['kabupaten_kota','kabupaten','name','kota','nama']) ||
                           getProp(props, ['kecamatan','name','nama']) ||
                           getProp(props, ['kelurahan_desa','name','nama']);
              if (name) layer.bindTooltip(name, { sticky: true, direction: 'top' });
            }
            
            // ----------------------
            // Kab/Kota layer (tampilkan semua)
            // ----------------------
            if (typeof diy_kabupaten_kota === 'undefined') {
                alert('File diy_kabupaten_kota.js tidak ditemukan atau variabel diy_kabupaten_kota undefined.');
            }
            else {
              kabupatenLayer = L.geoJSON(diy_kabupaten_kota, {
                style: styleKabupaten,
                onEachFeature: function (feature, layer) {
                  bindTooltip(layer, feature.properties);
            
                  layer.on({
                    mouseover() {
                      layer.setStyle(styleKabupatenHover);
                      const title = getProp(feature.properties, ['kabupaten_kota','name','kabupaten','nama']);
                      info.update({ title: title || 'Kabupaten / Kota', subtitle: 'Kabupaten / Kota' });
                    },
                    mouseout() {
                      if (selectedKabupaten !== layer) kabupatenLayer.resetStyle(layer);
                      info.update();
                    },
                    click() {
                      // pilih kabupaten -> zoom & tampilkan kecamatan
                      if (selectedKabupaten && selectedKabupaten !== layer) kabupatenLayer.resetStyle(selectedKabupaten);
                      selectedKabupaten = layer;
                      layer.setStyle({ color: '#b22222', weight: 3, fillOpacity: 0.18 });
                      
                      // popup sederhana
                      const title = getProp(feature.properties, ['kabupaten_kota','name','kabupaten','nama']);
                      const code = getProp(feature.properties, ['kode','id','code']);
                      // layer.bindPopup(`<b>${title || 'Kabupaten'}</b><br>${code ? 'Kode: ' + code : ''}`).openPopup(); // ABDP

                      map.fitBounds(layer.getBounds(), { maxZoom: 13 });
                      showKecamatanFor(title);
                    }
                  });
                }
              }).addTo(map);
            }
            
            // ----------------------
            // Kelurahan layer (tetap kosong sampai diperlukan)
            // ----------------------
            kelurahanLayer = L.geoJSON(null, {
              style: styleKelurahan,
              onEachFeature(feature, layer) {
                bindTooltip(layer, feature.properties);
                layer.on({
                  mouseover() { layer.setStyle(styleKelurahanHover); info.update({ title: getProp(feature.properties, ['kelurahan_desa','name','nama']), subtitle: 'Kelurahan / Desa' }); },
                  mouseout() { kelurahanLayer.resetStyle(layer); info.update(); },
                  click() {
                    // tampilkan popup + zoom
                    const title = getProp(feature.properties, ['kelurahan_desa','name','nama']);
                    const code = getProp(feature.properties, ['kode','id','code']);
                    // layer.bindPopup(`<b>${title || 'Kelurahan'}</b><br>${code ? 'Kode: ' + code : ''}`).openPopup(); // ABDP
                    map.fitBounds(layer.getBounds(), { maxZoom: 17 });
                  }
                });
              }
            }).addTo(map);
            
            // ----------------------
            // Fungsi: tampilkan kecamatan untuk sebuah kabupaten (nama matching case-insensitive)
            // ----------------------
            function showKecamatanFor(namaKabupaten) {
              // bersihkan layer kelurahan
              kelurahanLayer.clearLayers();
            
              if (!namaKabupaten) {
                console.info('Nama kabupaten kosong, batalkan showKecamatanFor.');
                return;
              }
              const nk = normalize(namaKabupaten);
            
              // ambil fitur kecamatan dari diy_kecamatan
              const feats = (Array.isArray(diy_kecamatan && diy_kecamatan.features) ? diy_kecamatan.features : []).filter(f => {
                const pk = f.properties || {};
                const cand = getProp(pk, ['kabupaten_kota','kabupaten','kabkota','kota']);
                return normalize(cand) === nk;
              });
            
              if (feats.length === 0) {
                console.info('Tidak ditemukan kecamatan untuk kabupaten:', namaKabupaten);
                // hapus layer kecamatan lama jika ada
                if (kecamatanLayer && map.hasLayer(kecamatanLayer)) map.removeLayer(kecamatanLayer);
                return;
              }
            
              // buat layer kecamatan hanya dari fitur relevan
              const newKecLayer = L.geoJSON(feats, {
                style: styleKecamatan,
                onEachFeature(feature, layer) {
                  bindTooltip(layer, feature.properties);
                  layer.on({
                    mouseover() { layer.setStyle(styleKecamatanHover); info.update({ title: getProp(feature.properties, ['kecamatan','name','nama']), subtitle: 'Kecamatan' }); },
                    mouseout() { if (selectedKecamatan !== layer && kecamatanLayer) kecamatanLayer.resetStyle(layer); info.update(); },
                    click() {
                      // pilih kecamatan -> zoom + tampilkan kelurahan
                      if (selectedKecamatan && selectedKecamatan !== layer && kecamatanLayer) kecamatanLayer.resetStyle(selectedKecamatan);
                      selectedKecamatan = layer;
                      layer.setStyle({ color: '#800000', weight: 3, fillOpacity: 0.2 });
            
                      const title = getProp(feature.properties, ['kecamatan','name','nama']);
                      const code = getProp(feature.properties, ['kode','id','code']);
                      // layer.bindPopup(`<b>${title || 'Kecamatan'}</b><br>${code ? 'Kode: ' + code : ''}`).openPopup(); // ABDP
            
                      map.fitBounds(layer.getBounds(), { maxZoom: 15 });
                      showKelurahanFor(title);
                    }
                  });
                }
              });
            
              // ganti kecamatanLayer lama
              if (kecamatanLayer && map.hasLayer(kecamatanLayer)) map.removeLayer(kecamatanLayer);
              kecamatanLayer = newKecLayer.addTo(map);
              kecamatanLayer.eachLayer(l => l.bringToFront());
            }
            
            // ----------------------
            // Fungsi: tampilkan kelurahan berdasarkan nama kecamatan (case-insensitive)
            // ----------------------
            function showKelurahanFor(namaKecamatan) {
              kelurahanLayer.clearLayers();
              if (!namaKecamatan) return;
              const nk = normalize(namaKecamatan);
            
              const feats = (Array.isArray(diy_kelurahan_desa && diy_kelurahan_desa.features) ? diy_kelurahan_desa.features : []).filter(f => {
                const pk = f.properties || {};
                const cand = getProp(pk, ['kecamatan','Kecamatan','kec']);
                return normalize(cand) === nk;
              });
            
              if (feats.length === 0) {
                console.info('Tidak ada kelurahan untuk kecamatan:', namaKecamatan);
                return;
              }
            
              kelurahanLayer.addData(feats);
              kelurahanLayer.eachLayer(l => l.bringToFront());
              // Jangan otomatis fitBounds ke kelurahan — kita sudah zoom saat klik kecamatan.
            }
            
            // ----------------------
            // Bangun / tampilkan provinsi
            // - Jika variable diy_provinsi tersedia, gunakan langsung.
            // - Jika tidak tersedia, union semua kabupaten; kalau union gagal, fallback ke bbox polygon.
            // ----------------------
            (function initProvinsiView() {
              try {
                if (typeof diy_provinsi !== 'undefined' && diy_provinsi && diy_provinsi.features && diy_provinsi.features.length > 0) {
                  provinsiLayer = L.geoJSON(diy_provinsi, {
                    style: styleProvinsi,
                    onEachFeature(feature, layer) {
                      const name = getProp(feature.properties, ['provinsi','name','nama']) || 'Provinsi';
                      layer.bindTooltip(name, { sticky: true, direction: 'center' });
                    }
                  }).addTo(map);
                  // fitBounds
                  const b = provinsiLayer.getBounds();
                  if (b && b.isValid())
                    map.fitBounds(b);
                } else {
                  // build from diy_kabupaten_kota
                  const feats = Array.isArray(diy_kabupaten_kota && diy_kabupaten_kota.features) ? diy_kabupaten_kota.features : [];
                  if (feats.length === 0) {
                    // fallback to current view
                    console.warn('Tidak ada fitur kabupaten untuk buat provinsi.');
                    return;
                  }
            
                  // try union pairwise; jika gagal gunakan bbox fallback
                  let unionPoly = feats[0];
                  let unionSucceeded = true;
                  for (let i = 1; i < feats.length; i++) {
                    try {
                      unionPoly = turf.union(unionPoly, feats[i]);
                    } catch (err) {
                      console.warn('turf.union gagal pada index', i, err);
                      unionSucceeded = false;
                      break;
                    }
                  }
            
                  if (!unionSucceeded) {
                    // fallback: buat polygon dari bbox gabungan semua kabupaten
                    const fullFc = turf.featureCollection(feats);
                    const bbox = turf.bbox(fullFc);
                    unionPoly = turf.bboxPolygon(bbox);
                  }
            
                  provinsiLayer = L.geoJSON(unionPoly, {
                    style: styleProvinsi,
                    onEachFeature(feature, layer) {
                      const name = (feature.properties && (feature.properties.provinsi || feature.properties.name)) || 'Provinsi (gabungan)';
                      layer.bindTooltip(name, { sticky: true, direction: 'center' });
                    }
                  }).addTo(map);
            
                  // fit bounds ke provinsi
                  const b = provinsiLayer.getBounds();
                  if (b && b.isValid()) map.fitBounds(b);
                }
            
                // taruh kabupaten di atas
                if (kabupatenLayer) kabupatenLayer.eachLayer(l => l.bringToFront());
              } catch (err) {
                console.error('initProvinsiView error:', err);
              }
            })();
            
            // ----------------------
            // Reset to province view (control)
            // ----------------------
            function resetToProvince() {
              kelurahanLayer.clearLayers();
              if (kecamatanLayer && map.hasLayer(kecamatanLayer)) map.removeLayer(kecamatanLayer);
              if (kabupatenLayer) kabupatenLayer.eachLayer(l => kabupatenLayer.resetStyle(l));
              selectedKabupaten = null;
              selectedKecamatan = null;
              if (provinsiLayer && provinsiLayer.getBounds && provinsiLayer.getBounds().isValid()) {
                map.fitBounds(provinsiLayer.getBounds());
              } else if (kabupatenLayer && kabupatenLayer.getBounds && kabupatenLayer.getBounds().isValid()) {
                map.fitBounds(kabupatenLayer.getBounds());
              }
              info.update();
            }
            
            const ResetControl = L.Control.extend({
              options: { position: 'topleft' },
              onAdd: function () {
                const c = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-reset');
                c.innerHTML = 'Reset to Province';
                c.style.padding = '6px';
                c.style.background = 'white';
                c.style.cursor = 'pointer';
                L.DomEvent.on(c, 'click', function (e) { e.stopPropagation(); resetToProvince(); });
                return c;
              }
            });
            map.addControl(new ResetControl());
            
            // klik background tidak melakukan apa-apa (atau uncomment jika mau reset)
            map.on('click', function (e) {
              // resetToProvince();
            });
            
        </script>
    </body>
</html>